import{r as d,j as k}from"./index-dff05267.js";import{R as b,m as I,i as M}from"./prismaInit-7a064fec.js";import{l as x,F as D}from"./index-4a232f34.js";import{m as q}from"./utils-9b986f1e.js";import{u as P}from"./useCurrentEntity-a45660c4.js";const _=/^\s*\/\/\s*[qQ]:(.*)$/,$=`// ai end
`,j=/^\s*\/\/\s*ai end/;function L(t){var o;const r=t.match(_);return(o=r==null?void 0:r[1])==null?void 0:o.trim()}function O(t){return!!t.match(j)}const A={prisma:"后续问题请使用prisma代码回答，符合prisma规范，包含表和字段注释",typescript:"后续问题请使用typeScript代码回答，符合typeScript语法，包含代码和注释"},K={prisma:"请根据后续要求优化下列代码，输出内容需要保持完整，未优化部分也要原样回传。请使用prisma代码回答，符合prisma规范，包含表和字段注释",typescript:"请根据后续要求优化下列代码，输出内容需要保持完整，未优化部分也要原样回传。使用typeScript代码回答，符合typeScript语法，包含代码和注释"};function Q(t,r){let o=!1,a=0,f=!0,s=!0,e=r;function i(c){t.executeEdits("",[{range:e,text:c}]),c===`
`?e=new b(e.startLineNumber+1,1,e.endLineNumber+1,1):e=new b(e.startLineNumber,e.startColumn+c.length,e.endLineNumber,e.endColumn+c.length)}return function(c){s&&(s=!1,c[0]!=="`"&&i("// "));for(let u=0;u<c.length;u++){const n=c[u];if(n==="`"&&f){a++,a===3&&(o=!o);continue}a=0,n===`
`?(i(n),o||i("// "),f=!0):(!o&&e.startColumn>=60&&(console.log(o,e.startColumn),i(`
`),i("// ")),i(n),f=!1)}}}async function S(t,r,o,a,f){let s=t;f&&(s=s+",其他内容不变");const e=Q(o,a),c=(await fetch("https://fb-node-server.onrender.com/ai_stream",{method:"POST",headers:new Headers({"Content-Type":"application/json"}),body:JSON.stringify({messages:[{role:"system",content:f?K[r]+`
\`\`\`
${f}
\`\`\``:A[r]},{role:"user",content:s}]})})).body.getReader(),u=new TextDecoder,n=[];for(;;){const{done:l,value:p}=await c.read();if(l)break;u.decode(p).split(`
`).map(E=>E.trim()).filter(Boolean).forEach(E=>{var y,h,C;const m=E.substring(6);try{if(m!=="[DONE]"){const g=JSON.parse(m);if((C=(h=(y=g==null?void 0:g.choices)==null?void 0:y[0])==null?void 0:h.delta)!=null&&C.content){const R=g.choices[0].delta.content;e(R),n.push(R)}}}catch(g){console.error(g)}})}}function v(t,r,o){const a=t.getModel();if(!a){console.error("未获取到model");return}const f=a.getLinesContent();let s,e,i=0;if(f.find((c,u)=>{if(s===void 0)L(c)===r&&(i===o&&(s=u),i++);else if(O(c))return e=u,!0}),s!==void 0)return new b(s+2,1,e?e+2:s+2,1)}async function w(t,r,o,a=!1){var i,c;const f=t.getModel();if(!f)return;const s=f.getLineContent(r),e=L(s);if(e){let u=0,n=0;f.getLinesContent().forEach((m,y)=>{L(m)===e&&(r-1===y&&(n=u),u++)});let l="";if(a){const m=v(t,e,n);if(m&&(m.setEndPosition(m.endLineNumber-1,1),l=((c=(i=t.getModel())==null?void 0:i.getValueInRange)==null?void 0:c.call(i,m))??""),!l){console.error("未找到当前代码内容");return}}const p=v(t,e,n);if(!p)return;t.executeEdits("",[{range:p,text:`
`+$}]);const N=t.onKeyUp(m=>{m.preventDefault()}),E=t.onKeyDown(m=>{m.preventDefault()});try{a?await S(e,o,t,p,l):await S(e,o,t,p)}catch(m){console.error(m)}N.dispose(),E.dispose()}}function T(t,r){t.onKeyUp(async o=>{if(o.keyCode===3){const{lineNumber:a}=t.getPosition()||{};if(a===void 0)return;await w(t,a-1,r)}})}function B(t,r,o){const a=r.addCommand(0,function(s,e){w(r,e,o)}),f=r.addCommand(0,function(s,e){w(r,e,o,!0)});return t.languages.registerCodeLensProvider(o,{provideCodeLenses:function(s){const e=s.getLinesContent(),i=[];return e.forEach((c,u)=>{L(c)&&(i.push({range:{startLineNumber:u+1,startColumn:1,endLineNumber:u+1,endColumn:1},id:"ai",command:{id:a,title:"AI生成",arguments:[u+1]}}),i.push({range:{startLineNumber:u+1,startColumn:1,endLineNumber:u+1,endColumn:1},id:"ai2",command:{id:f,title:"AI优化",arguments:[u+1]}}))}),{lenses:i,dispose:()=>{}}}})}x.config({monaco:I});const H=({onChange:t,defaultContent:r,onUpdateValidate:o,actionRef:a,onReady:f})=>{const s=d.useRef(),{currentEntity:e}=P(),i=d.useRef(""),c=d.useRef("");d.useEffect(()=>{if(!e)return;const n=`${e.type}_${e.id}`;if(i.current!==n&&(i.current=n,s.current)){const l=s.current.getValue().split(`
`).findIndex(p=>!!p.match(new RegExp(`${e.type}\\s+${e.name}\\s+\\{`)));s.current.revealLineInCenter(l)}},[e]),d.useEffect(()=>{t==null||t(r),c.current=r,s.current&&s.current.setValue(r)},[r]);const u=d.useRef();return d.useEffect(()=>()=>{var n;(n=u.current)==null||n.dispose()},[]),k.jsx("div",{className:"h-full bg-red",children:k.jsx(D,{language:"prisma",defaultLanguage:"prisma",options:{autoClosingBrackets:"always"},onValidate:n=>{o==null||o(!n.length)},beforeMount:n=>{},onMount:(n,l)=>{console.log("prisma editor mounted",n,l),M(l,n),u.current=B(l,n,"prisma"),T(n,"prisma"),a&&(a.current=n),s.current=n,s.current.setValue(c.current),q(n),f==null||f()},defaultValue:c.current,onChange:n=>{t==null||t(n??"")}})})};export{H as M};
