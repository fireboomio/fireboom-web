import{r as u,A as Z,h as ee,K as T,n as te,u as se,X as J,j as e,ad as ae,W as ne,V as h,T as F,Q as O}from"./index-e23f2223.js";import{p as le}from"./fireBoomAPIOperator-eaf8363a.js";import{D as oe,e as ie,E as re,M as ce,U as V}from"./fireBoomConstants-acaaa4c8.js";import{P as X}from"./PrismaSchemaContext-667f643c.js";import{c as de}from"./ModelingHelpers-3ecfe378.js";import{a as me,b as Y,u as K,P as R}from"./useEntities-1eaa8085.js";import{u as z}from"./useCurrentEntity-29b7e336.js";import{r as W}from"./hotkey-3a258436.js";import{g as ue}from"./datasource-e384a503.js";import{S as fe}from"./index-27b087ac.js";import{i as $}from"./use-immer.module-4cb1830e.js";import{D as pe,M as ge}from"./index-d35cf63a.js";import{P as G}from"./index-3969b2b7.js";import"./toNumber-f5e42bde.js";import"./PrismaSchemaActions-5cb76651.js";import"./ServiceDiscovery-59c29267.js";import"./useShowArrow-12d59a8d.js";import"./index-7fdf62f6.js";import"./DownOutlined-a9c475b8.js";import"./PurePanel-08b7f9fd.js";import"./LeftOutlined-e9646426.js";import"./index-ea05c07e.js";import"./index-fac314a2.js";var he={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M904 512h-56c-4.4 0-8 3.6-8 8v320H184V184h320c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V520c0-4.4-3.6-8-8-8z"}},{tag:"path",attrs:{d:"M355.9 534.9L354 653.8c-.1 8.9 7.1 16.2 16 16.2h.4l118-2.9c2-.1 4-.9 5.4-2.3l415.9-415c3.1-3.1 3.1-8.2 0-11.3L785.4 114.3c-1.6-1.6-3.6-2.3-5.7-2.3s-4.1.8-5.7 2.3l-415.8 415a8.3 8.3 0 00-2.3 5.6zm63.5 23.6L779.7 199l45.2 45.1-360.5 359.7-45.7 1.1.7-46.4z"}}]},name:"form",theme:"outlined"};const ve=he;var xe=function(d,c){return u.createElement(Z,ee({},d,{ref:c,icon:ve}))},Me=u.forwardRef(xe);const _e=Me,je=""+new URL("refresh-7936fd77.svg",import.meta.url).href,Ee="_pannel_11jtl_1",ye="_title_11jtl_6",we="_select_11jtl_11",ke="_actions_11jtl_14",Ne="_manage_11jtl_22",Be="_refreshBtn_11jtl_60",be="_switchBtn_11jtl_72",Ce="_erBtn_11jtl_78",Ae="_addEntityBtn_11jtl_84",Re="_item_11jtl_97",Te="_icon_11jtl_108",Ie="_dropdownIcon_11jtl_116",Se="_editMark_11jtl_130",Le="_addMark_11jtl_131",De="_itemActive_11jtl_134",Ue="_name_11jtl_148",n={pannel:Ee,title:ye,select:we,actions:ke,manage:Ne,"option-icon":"_option-icon_11jtl_25","select-contain":"_select-contain_11jtl_31","delete-label":"_delete-label_11jtl_39","add-btn":"_add-btn_11jtl_42","dropdown-icon":"_dropdown-icon_11jtl_52",refreshBtn:Be,switchBtn:be,erBtn:Ce,addEntityBtn:Ae,item:Re,icon:Te,dropdownIcon:Ie,editMark:Se,addMark:Le,itemActive:De,name:Ue},Pe=({sourceOptions:s,onChangeSource:d})=>{const c=T(),{mutate:f}=te();me();const i=se(),{name:o}=J(),a=()=>{i(ie)};return u.useEffect(()=>{s.length>0&&!o&&i(`/workbench/modeling/${s[0].name}`)},[s,i,o]),e.jsxs("div",{className:"common-form "+n["select-contain"],children:[e.jsx(fe,{className:n.select,onChange:l=>{i(`/workbench/modeling/${l}`)},optionLabelProp:"label",value:o,options:s.map(l=>{const p=ue(l);return{label:e.jsxs("div",{className:"flex items-center",children:[e.jsx("img",{className:"mr-1 w-3 h-3",alt:l.name,src:p}),l.name]}),value:l.name}}),dropdownRender:l=>e.jsxs("div",{className:"divide-y",children:[l,e.jsx("div",{className:"text-center",children:e.jsx(ae,{className:"w-full",icon:e.jsx(_e,{}),type:"link",onClick:a,children:c.formatMessage({id:"O1HTOa",defaultMessage:[{type:0,value:"管理"}]})})})]})}),e.jsx("div",{className:n.refreshBtn,onClick:()=>{f(oe),o&&d(o)},children:e.jsx("img",{alt:"刷新",src:je,className:"w-4 h-4"})})]})},Fe=""+new URL("del-967f6233.svg",import.meta.url).href,Oe=""+new URL("entity-active-695b4f14.svg",import.meta.url).href,$e=""+new URL("entity-f4366b1c.svg",import.meta.url).href,Xe=""+new URL("enum-active-50867240.svg",import.meta.url).href,ze=""+new URL("enum-4b47b629.svg",import.meta.url).href,He=""+new URL("more-7449b878.svg",import.meta.url).href,Ve=""+new URL("rename-b624bb15.svg",import.meta.url).href,Ge=({entity:s,onClick:d,onToggleDesigner:c,setShowType:f,editFlag:i,newFlag:o})=>{const a=T(),{currentEntityId:l,changeToEntityById:p}=z(),{blocks:v,updateAndSaveBlock:y,applyLocalBlocks:w}=Y(),[I,k]=$(!1),[S,g]=$(s.name===""),[N,x]=$(!1),{getFirstEntity:M}=K(),{panel:L,triggerSyncEditor:D,loadDataSource:U}=u.useContext(X),{inEdit:_}=L||{},r=l===s.id,P=t=>{t.domEvent.stopPropagation(),(t.key==="1"||t.key==="2")&&x(!1)},B=t=>{t.key==="Escape"&&g(!1)},j=()=>{var t,C;if(x(!1),_){const m=R(v).deleteEntity(s.id);w(m),D();const A=m.find(H=>H.type==="model"||H.type==="enum");p(A?A.id:0)}else{r&&(p(((t=M())==null?void 0:t.id)??0),f(((C=M())==null?void 0:C.type)==="model"?"preview":"editEnum"));const m=h.loading(a.formatMessage({id:"fblGdv",defaultMessage:[{type:0,value:"删除中"}]}),0);y(R(v).deleteEntity(s.id)).then(()=>{h.success(a.formatMessage({id:"aiBGBs",defaultMessage:[{type:0,value:"删除成功"}]})),U()}).finally(()=>{m()})}},b=t=>{if(g(!1),t===s.name)return;if(!t){h.error(a.formatMessage({id:"qNBYXi",defaultMessage:[{type:0,value:"实体名不可为空！"}]}));return}const C=new RegExp(re).test(t);if(t===ce||!C){h.error(a.formatMessage({id:"VSwka6",defaultMessage:[{type:0,value:"实体名不合法！"}]}));return}if(_){g(!1);const m=R(v).updateEntityName(s.id,t);w(m),D()}else{const m=h.loading(a.formatMessage({id:"IyVzrX",defaultMessage:[{type:0,value:"保存中"}]}),0);y(R(v).updateEntityName(s.id,t)).then(()=>{h.success(a.formatMessage({id:"AXTXwf",defaultMessage:[{type:0,value:"实体名更新成功"}]}))}).catch(A=>h.error(a.formatMessage({id:"Ul2EcR",defaultMessage:[{type:0,value:"实体名更新失败, error:"}]})+`${A.message}`)).finally(()=>{m()})}},E=t=>{t||(k(!1),x(!1))},Q=()=>e.jsx(ge,{onClick:P,items:[{key:1,label:e.jsx(G,{placement:"right",title:a.formatMessage({id:"Gdu/zD",defaultMessage:[{type:0,value:"重命名会导致表中数据全部丢失，请谨慎操作！"}]}),onConfirm:()=>g(!S),okType:"danger",okText:a.formatMessage({id:"JeJAmT",defaultMessage:[{type:0,value:"重命名"}]}),children:e.jsx("span",{children:a.formatMessage({id:"JeJAmT",defaultMessage:[{type:0,value:"重命名"}]})})}),icon:e.jsx("img",{src:Ve,alt:"重命名"})},{key:4,label:e.jsx(G,{className:"h-full w-full",placement:"right",title:a.formatMessage({id:"B9XR0F",defaultMessage:[{type:0,value:"确认删除该实体吗？将会同时删除引用字段！"}]}),onConfirm:j,okText:a.formatMessage({id:"XeiAal",defaultMessage:[{type:0,value:"删除"}]}),cancelText:a.formatMessage({id:"2QzYmY",defaultMessage:[{type:0,value:"取消"}]}),onCancel:()=>x(!1),overlayClassName:n["delete-label"],okType:"danger",children:e.jsx("span",{children:a.formatMessage({id:"XeiAal",defaultMessage:[{type:0,value:"删除"}]})})}),icon:e.jsx("img",{src:Fe,alt:"删除"})}]}),q=S?e.jsx(ne,{onBlur:t=>b(t.target.value),onKeyUp:B,onPressEnter:t=>b(t.currentTarget.value),className:"font-normal h-5 text-sm pl-1 leading-4 w-5/7",defaultValue:s.name,autoFocus:!0,placeholder:a.formatMessage({id:"ldUt6r",defaultMessage:[{type:0,value:"请输入实体名"}]})}):e.jsx("div",{className:"text-sm font-normal leading-4 "+n.name,children:s.name});return e.jsxs("div",{className:`${n.item} ${r?n.itemActive:""}`,onMouseEnter:()=>k(!0),onMouseLeave:()=>E(N),onClick:d,onDoubleClick:()=>g(!0),children:[e.jsx("div",{className:n.icon,children:s.type==="model"?e.jsx("img",{src:r?Oe:$e,alt:"模型"}):e.jsx("img",{src:r?Xe:ze,alt:"枚举"})}),q,i?e.jsx("div",{className:n.editMark}):null,o?e.jsx("div",{className:n.addMark}):null,e.jsx(pe,{dropdownRender:Q,trigger:["click"],placement:"bottomRight",open:N,onOpenChange:t=>{x(t),E(t)},children:e.jsx("div",{className:n.dropdownIcon,onClick:t=>t.stopPropagation(),children:e.jsx("img",{src:He,alt:"菜单"})})})]},s.id)},Je=""+new URL("er-158e0757.svg",import.meta.url).href,Ye=""+new URL("modeling-switch-afd2342d.svg",import.meta.url).href,Ke=({changeToER:s,addNewModel:d})=>{const c=T(),{panel:f}=u.useContext(X),{handleSetInEdit:i,inEdit:o}=f||{},{currentEntity:a}=z();let l=o?c.formatMessage({id:"ueuJlz",defaultMessage:[{type:0,value:"数据建模"}]}):c.formatMessage({id:"ayODEw",defaultMessage:[{type:0,value:"数据预览"}]});return a||(l=c.formatMessage({id:"ueuJlz",defaultMessage:[{type:0,value:"数据建模"}]})),u.useEffect(()=>W("alt+t,^+t",()=>{i(!o)}),[i,o]),e.jsxs("div",{className:n.actions,children:[e.jsx("span",{className:"font-500 text-[#333] text-14px",children:l}),e.jsx("div",{className:"ml-1 mr-auto text-[10px] text-red p-1 rounded bg-[#aaa] text-white transform scale-88",children:"Beta"}),e.jsx("div",{onClick:()=>i(!o),className:n.switchBtn,children:e.jsx(F,{title:e.jsx(O,{id:"6Coego",defaultMessage:[{type:0,value:"切换数据预览和数据建模"}]}),children:e.jsx("img",{src:Ye,alt:"switch"})})}),e.jsx("div",{onClick:s,className:n.erBtn,children:e.jsx(F,{title:e.jsx(O,{id:"GhA32s",defaultMessage:[{type:0,value:"ER图"}]}),children:e.jsx("img",{src:Je,alt:"ER"})})}),e.jsx("div",{onClick:d,className:n.addEntityBtn,children:e.jsx(F,{title:e.jsx(O,{id:"m20fpm",defaultMessage:[{type:0,value:"新建模型"}]}),children:"+"})})]})},Mt=({sourceOptions:s,onChangeSource:d,onClickEntity:c,onToggleDesigner:f,changeToER:i,addNewModel:o,setShowType:a})=>{const l=T(),{entities:p,editMap:v,newMap:y,delMap:w}=K();z();const{panel:I,triggerSyncEditor:k,dispatch:S}=u.useContext(X),{handleClickEntity:g}=I,{handleSetInEdit:N,inEdit:x}=I||{},{name:M}=J(),{blocks:L,applyLocalSchema:D,applyLocalBlocks:U}=Y(),_=async()=>{const P=`
model ${`${V}${Math.max(0,...p.map(b=>{const E=b.name.match(new RegExp(`${V}(\\d*)`));return E?Number(E[1]):0}))+1}`} {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}
`;let B=le({type:"schema",list:L});B+=P;const j=de(B);U(j),k(),setTimeout(()=>{g(j[j.length-1]),N(!0)},100)};return u.useEffect(()=>W("alt+n,^+n",()=>{_()}),[]),e.jsxs("div",{className:"flex flex-col flex-1 min-h-0",children:[e.jsxs("div",{className:n.pannel,children:[e.jsx(Pe,{sourceOptions:s,onChangeSource:d}),M&&M!=="0"&&e.jsx(Ke,{addNewModel:_,changeToER:i})]}),e.jsx("div",{className:"flex-1 mt-1 overflow-y-auto",children:p.map(r=>e.jsx(Ge,{editFlag:v[r.name],newFlag:y[r.name],setShowType:a,entity:r,onClick:()=>c(r),onToggleDesigner:f},r.id))}),Object.keys(w).length?e.jsx("div",{className:"bg-[#f7f7f7] rounded-4px m-2 px-3 text-[#666] leading-32px",children:l.formatMessage({id:"M5bmPZ",defaultMessage:[{type:0,value:"系统检测到您可能删除或重命名了模型，迁移后将导致数据丢失，请谨慎操作"}]})}):null]})};export{Mt as default};
