import{p as Q}from"./fireboom-prisma-ast.esm.6ae74454.js";import{r as h,j as e,$ as Z,a0 as z,d as P,u as ee,b4 as j,f as E,B as te,I as se,m as v}from"./index.e5e6c754.js";import{D as ae,j as ne,E as oe,M as le,U as V,k as ie}from"./ModelingHelpers.b83dc1e3.js";import{P as H}from"./PrismaSchemaContext.c1116ab6.js";import{b as ue,s as o,u as U,c as Y,a as G,P as S}from"./pannel.module.e5b79f38.js";import{r as J}from"./printer.b0e2956d.js";import"./iconUtil.31c13224.js";import"./index.5e1fa168.js";import{S as re}from"./index.daad23d2.js";import{u as ce}from"./index.esm.e5edd667.js";import{D as de,M as me}from"./conductUtil.03f406cc.js";import"./index.67bc873e.js";import{P as pe}from"./index.6fa46df0.js";import{i as q}from"./use-immer.module.1d9a0526.js";import"./_createAggregator.87a98d7b.js";import"./get.131f9f4f.js";import"./_baseGet.6a7418c9.js";import"./_baseClone.e2094da0.js";import"./flatten.8e198855.js";import"./_baseSet.aed078ba.js";import"./uniq.2129c997.js";import"./_baseUniq.d23dbdee.js";import"./difference.6d57e3ed.js";import"./groupBy.88271069.js";import"./DownOutlined.75881d1e.js";import"./KeyCode.9c493596.js";import"./index.b6cece06.js";import"./pickAttrs.c5bbb5fc.js";import"./Overflow.321ca619.js";import"./RightOutlined.73e4cc97.js";import"./index.e54b5c9c.js";import"./index.6f73eb32.js";import"./DialogWrap.947e0e2f.js";var ge={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M904 512h-56c-4.4 0-8 3.6-8 8v320H184V184h320c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V520c0-4.4-3.6-8-8-8z"}},{tag:"path",attrs:{d:"M355.9 534.9L354 653.8c-.1 8.9 7.1 16.2 16 16.2h.4l118-2.9c2-.1 4-.9 5.4-2.3l415.9-415c3.1-3.1 3.1-8.2 0-11.3L785.4 114.3c-1.6-1.6-3.6-2.3-5.7-2.3s-4.1.8-5.7 2.3l-415.8 415a8.3 8.3 0 00-2.3 5.6zm63.5 23.6L779.7 199l45.2 45.1-360.5 359.7-45.7 1.1.7-46.4z"}}]},name:"form",theme:"outlined"};const fe=ge;var K=function(r,u){return e(Z,{...z(z({},r),{},{ref:u,icon:fe})})};K.displayName="FormOutlined";const ve=h.exports.forwardRef(K),Ee="/assets/refresh.7936fd77.svg",he=({sourceOptions:a,onChangeSource:r})=>{const u=P(),{mutate:p}=ce(),{id:c}=ue(),i=ee(),{id:s}=j(),d=()=>{i(ne)};return h.exports.useEffect(()=>{a.length>0&&!s&&i(`/workbench/modeling/${a[0].id}`)},[a,s]),E("div",{className:"common-form "+o["select-contain"],children:[e(re,{className:o.select,onChange:n=>{i(`/workbench/modeling/${n}`)},optionLabelProp:"label",value:s&&s!=="0"?Number(s):"",options:a.map(n=>{let l="/assets/icon/db-other.svg";switch(n.sourceType){case 1:l={mysql:"/assets/icon/mysql.svg",pgsql:"/assets/icon/pg.svg",graphql:"/assets/icon/graphql.svg",mongodb:"/assets/icon/mongodb.svg",rest:"/assets/icon/rest.svg",sqlite:"/assets/icon/sqlite.svg"}[String(n.config.dbType).toLowerCase()]||l;break;case 2:l="/assets/icon/rest.svg";break;case 3:l="/assets/icon/graphql.svg";break}return{label:E("div",{className:"flex items-center",children:[e("img",{className:"mr-1 w-3 h-3",alt:n.name,src:l}),n.name]}),value:n.id}}),dropdownRender:n=>E("div",{className:"divide-y",children:[n,e("div",{className:"text-center",children:e(te,{className:"w-full",icon:e(ve,{}),type:"link",onClick:d,children:u.formatMessage({id:"O1HTOa",defaultMessage:[{type:0,value:"\u7BA1\u7406"}]})})})]})}),e("div",{className:o.refreshBtn,onClick:()=>{p(ae),r(c)},children:e("img",{alt:"\u5237\u65B0",src:Ee,className:"w-4 h-4"})})]})},Me="/assets/del.967f6233.svg",ye="/assets/entity.f4366b1c.svg",Fe="/assets/entity-active.695b4f14.svg",Be="/assets/enum.4b47b629.svg",Ce="/assets/enum-active.50867240.svg",De="/assets/more.7449b878.svg",ke="/assets/rename.b624bb15.svg",Ne=({entity:a,onClick:r,onToggleDesigner:u,setShowType:p,editFlag:c,newFlag:i})=>{const s=P(),{currentEntityId:d,changeToEntityById:n}=U(),{blocks:l,updateAndSaveBlock:D,applyLocalBlocks:k}=Y(),[R,N]=q(!1),[L,g]=q(a.name===""),[b,M]=q(!1),{getFirstEntity:C}=G(),{panel:O,triggerSyncEditor:$}=h.exports.useContext(H),{inEdit:A}=O||{},f=d===a.id,m=t=>{t.domEvent.stopPropagation(),(t.key==="1"||t.key==="2")&&M(!1)},_=t=>{t.key==="Escape"&&g(!1)},x=()=>{var t,I,F;if(M(!1),A){const B=S(l).deleteEntity(a.id);k(B),$(),n(B.filter(X=>X.type==="model"||X.type==="enum")[0].id)}else{f&&(n((I=(t=C())==null?void 0:t.id)!=null?I:0),p(((F=C())==null?void 0:F.type)==="model"?"preview":"editEnum"));const B=v.loading(s.formatMessage({id:"fblGdv",defaultMessage:[{type:0,value:"\u5220\u9664\u4E2D"}]}),0);D(S(l).deleteEntity(a.id)).then(()=>{v.success(s.formatMessage({id:"aiBGBs",defaultMessage:[{type:0,value:"\u5220\u9664\u6210\u529F"}]}))}).finally(()=>{B()})}},y=t=>{if(g(!1),!t){v.error(s.formatMessage({id:"qNBYXi",defaultMessage:[{type:0,value:"\u5B9E\u4F53\u540D\u4E0D\u53EF\u4E3A\u7A7A\uFF01"}]}));return}const I=new RegExp(oe).test(t);if(t===le||!I){v.error(s.formatMessage({id:"VSwka6",defaultMessage:[{type:0,value:"\u5B9E\u4F53\u540D\u4E0D\u5408\u6CD5\uFF01"}]}));return}if(A){g(!1);const F=S(l).updateEntityName(a.id,t);k(F),$()}else{const F=v.loading(s.formatMessage({id:"IyVzrX",defaultMessage:[{type:0,value:"\u4FDD\u5B58\u4E2D"}]}),0);D(S(l).updateEntityName(a.id,t)).then(()=>{v.success(s.formatMessage({id:"AXTXwf",defaultMessage:[{type:0,value:"\u5B9E\u4F53\u540D\u66F4\u65B0\u6210\u529F"}]}))}).catch(B=>v.error(s.formatMessage({id:"Ul2EcR",defaultMessage:[{type:0,value:"\u5B9E\u4F53\u540D\u66F4\u65B0\u5931\u8D25, error:"}]})+`${B.message}`)).finally(()=>{F()})}},w=t=>{t||(N(!1),M(!1))},T=()=>e(me,{onClick:m,items:[{key:1,label:e("span",{children:s.formatMessage({id:"JeJAmT",defaultMessage:[{type:0,value:"\u91CD\u547D\u540D"}]})}),icon:e("img",{src:ke,alt:"\u91CD\u547D\u540D"}),onClick:()=>g(!L)},{key:4,label:e(pe,{className:"h-full w-full",placement:"right",title:s.formatMessage({id:"B9XR0F",defaultMessage:[{type:0,value:"\u786E\u8BA4\u5220\u9664\u8BE5\u5B9E\u4F53\u5417\uFF1F\u5C06\u4F1A\u540C\u65F6\u5220\u9664\u5F15\u7528\u5B57\u6BB5\uFF01"}]}),onConfirm:x,okText:s.formatMessage({id:"XeiAal",defaultMessage:[{type:0,value:"\u5220\u9664"}]}),cancelText:s.formatMessage({id:"2QzYmY",defaultMessage:[{type:0,value:"\u53D6\u6D88"}]}),onCancel:()=>M(!1),overlayClassName:o["delete-label"],okType:"danger",children:e("span",{children:s.formatMessage({id:"XeiAal",defaultMessage:[{type:0,value:"\u5220\u9664"}]})})}),icon:e("img",{src:Me,alt:"\u5220\u9664"})}]}),W=L?e(se,{onBlur:t=>y(t.target.value),onKeyUp:_,onPressEnter:t=>y(t.currentTarget.value),className:"font-normal h-5 text-sm pl-1 leading-4 w-5/7",defaultValue:a.name,autoFocus:!0,placeholder:s.formatMessage({id:"ldUt6r",defaultMessage:[{type:0,value:"\u8BF7\u8F93\u5165\u5B9E\u4F53\u540D"}]})}):e("div",{className:"text-sm font-normal leading-4 "+o.name,children:a.name});return E("div",{className:`${o.item} ${f?o.itemActive:""}`,onMouseEnter:()=>N(!0),onMouseLeave:()=>w(b),onClick:r,onDoubleClick:()=>g(!0),children:[e("div",{className:o.icon,children:a.type==="model"?e("img",{src:f?Fe:ye,alt:"\u6A21\u578B"}):e("img",{src:f?Ce:Be,alt:"\u679A\u4E3E"})}),W,c?e("div",{className:o.editMark}):null,i?e("div",{className:o.addMark}):null,e(de,{overlay:T,trigger:["click"],placement:"bottomRight",open:b,onOpenChange:t=>{M(t),w(t)},children:e("div",{className:o.dropdownIcon,onClick:t=>t.stopPropagation(),children:e("img",{src:De,alt:"\u83DC\u5355"})})})]},a.id)},be="/assets/modeling-switch.afd2342d.svg",Ae=({changeToER:a,addNewModel:r})=>{const u=P(),{panel:p}=h.exports.useContext(H),{handleSetInEdit:c,inEdit:i}=p||{},{currentEntity:s}=U();let d=i?u.formatMessage({id:"ueuJlz",defaultMessage:[{type:0,value:"\u6570\u636E\u5EFA\u6A21"}]}):u.formatMessage({id:"ayODEw",defaultMessage:[{type:0,value:"\u6570\u636E\u9884\u89C8"}]});return s||(d=u.formatMessage({id:"ueuJlz",defaultMessage:[{type:0,value:"\u6570\u636E\u5EFA\u6A21"}]})),h.exports.useEffect(()=>J("alt+t,^+t",()=>{c(!i)}),[c,i]),E("div",{className:o.actions,children:[e("span",{className:"mr-auto font-500 text-[#333] text-14px",children:d}),e("div",{onClick:()=>c(!i),className:o.switchBtn,children:e("img",{src:be,alt:"switch"})}),e("div",{onClick:r,className:o.addEntityBtn,children:"+"})]})},ut=({sourceOptions:a,onChangeSource:r,onClickEntity:u,onToggleDesigner:p,changeToER:c,addNewModel:i,setShowType:s})=>{const d=P(),{entities:n,editMap:l,newMap:D,delMap:k}=G();U();const{panel:R,triggerSyncEditor:N,dispatch:L}=h.exports.useContext(H),{handleClickEntity:g}=R,{handleSetInEdit:b,inEdit:M}=R||{},{id:C}=j(),{blocks:O,applyLocalSchema:$,applyLocalBlocks:A}=Y(),f=async()=>{const _=`
model ${`${V}${Math.max(0,...n.map(w=>{const T=w.name.match(new RegExp(`${V}(\\d*)`));return T?Number(T[1]):0}))+1}`} {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}
`;let x=Q({type:"schema",list:O});x+=_;const y=ie(x);A(y),N(),setTimeout(()=>{g(y[y.length-1]),b(!0)},100)};return h.exports.useEffect(()=>J("alt+n,^+n",()=>{f()}),[]),E("div",{className:"flex flex-col flex-1 min-h-0",children:[E("div",{className:o.pannel,children:[e(he,{sourceOptions:a,onChangeSource:r}),C&&C!=="0"&&e(Ae,{addNewModel:f,changeToER:c})]}),e("div",{className:"flex-1 mt-1 overflow-y-auto",children:n.map(m=>e(Ne,{editFlag:l[m.name],newFlag:D[m.name],setShowType:s,entity:m,onClick:()=>u(m),onToggleDesigner:p},m.id))}),Object.keys(k).length?e("div",{className:"bg-[#f7f7f7] rounded-4px m-2 px-3 text-[#666] leading-32px",children:d.formatMessage({id:"M5bmPZ",defaultMessage:[{type:0,value:"\u7CFB\u7EDF\u68C0\u6D4B\u5230\u60A8\u53EF\u80FD\u5220\u9664\u6216\u91CD\u547D\u540D\u4E86\u6A21\u578B\uFF0C\u8FC1\u79FB\u540E\u5C06\u5BFC\u81F4\u6570\u636E\u4E22\u5931\uFF0C\u8BF7\u8C28\u614E\u64CD\u4F5C"}]})}):null]})};export{ut as default};
