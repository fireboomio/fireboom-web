import{t as S,d as R,r as _,m as k}from"./index.e5e6c754.js";import{m as D,r as B,a as F,b as M,c as b,d as C}from"./ModelingHelpers.b83dc1e3.js";import{P as v}from"./PrismaSchemaContext.c1116ab6.js";const m={extractDefaultAttrArgs:e=>{var l;const{value:a}=(l=e[0])!=null?l:{value:void 0};return typeof a=="object"&&a.name||a},extractNormalAttrArgs:e=>{var r;const{value:a}=(r=e[0])!=null?r:{value:void 0};return a},extractIndexAttributeArgs:e=>{var s;const a=(s=e==null?void 0:e.map(n=>n.value))!=null?s:[],r=a.filter(n=>n.key==="fields").map(n=>n.value).flatMap(n=>n.args),l=a.length>=1?a[0].args:[],o=e==null?void 0:e.map(n=>n.value).filter(n=>n.key==="name").map(n=>n.value)[0],i=e==null?void 0:e.map(n=>n.value).filter(n=>n.key==="map").map(n=>n.value)[0];return{fields:r.length>0?r:l,name:o,map:i}},extractRelationAttributeArgs:e=>{var i,s,n;const a=e.map(t=>t.value).filter(t=>t.key==="name").map(t=>t.value)[0],r=(s=(i=e[0])==null?void 0:i.value)!=null&&s.key||(n=e[0])==null?void 0:n.value,l=e.map(t=>t.value).filter(t=>t.key==="fields").map(t=>t.value).flatMap(t=>t.args),o=e.map(t=>t.value).filter(t=>t.key==="references").map(t=>t.value).flatMap(t=>t.args);return{name:a||r,fields:l,references:o}},buildNewRelationArgs:(e,a,r)=>{const l=[];return e&&l.push({type:"attributeArgument",value:{type:"keyValue",key:"name",value:e}}),a&&a.length>0&&l.push({type:"attributeArgument",value:{type:"keyValue",key:"fields",value:{type:"array",args:a}}}),r&&r.length>0&&l.push({type:"attributeArgument",value:{type:"keyValue",key:"references",value:{type:"array",args:r}}}),l}},T=(e,a)=>{var i,s,n;const r=(i=e.attributes)==null?void 0:i.find(t=>t.name==="relation"),l=(n=(s=r==null?void 0:r.args)==null?void 0:s.map(t=>t.value).filter(t=>t.key==="fields").map(t=>t.value).flatMap(t=>t.args))!=null?n:[];return!!a.properties.filter(t=>t.type==="field").map(t=>t).filter(t=>l.includes(t.name)).find(t=>{var c;return(c=t.attributes)==null?void 0:c.find(u=>u.name==="unique")})},E=(e,a)=>{var o;const r=[...a];return e.properties=(o=e.properties)!=null?o:[],e.properties.filter(i=>i.type==="field").map(i=>i).filter(i=>{var s;return(s=i.attributes)==null?void 0:s.find(n=>n.name==="relation")}).forEach(i=>{var c,u,f;const s=i.fieldType,{name:n}=m.extractRelationAttributeArgs((f=(u=(c=i.attributes)==null?void 0:c.find(p=>p.name==="relation"))==null?void 0:u.args)!=null?f:[]),t=r.filter(p=>p.type==="model").map(p=>p).find(p=>p.name===s);if(t){const p=T(i,e);let h=!1;const w=t.properties.map(d=>{var y,A,g;if(d.type==="field"&&d.fieldType===e.name){if(n){const{name:x}=m.extractRelationAttributeArgs((g=(A=(y=d.attributes)==null?void 0:y.find(N=>N.name==="relation"))==null?void 0:A.args)!=null?g:[]);if(x!==n)return d}return h=!0,{...d,array:!p,optional:p}}return d});if(!h){const d={type:"attribute",kind:"field",name:"relation",args:m.buildNewRelationArgs(n,[],[])};w.push({type:"field",name:n?n.replaceAll('"',"").toLowerCase():`${e.name.toLowerCase()}${p?"":"s"}`,fieldType:e.name,array:!p,optional:p,attributes:n?[d]:[]})}r.forEach((d,y)=>{d.id===t.id&&(r[y]={...t,properties:w})})}}),r},P=(e,a,r)=>{const l=e.map(i=>i.fieldType),o=e.map(i=>{var s,n,t;return m.extractRelationAttributeArgs((t=(n=(s=i.attributes)==null?void 0:s.find(c=>c.name==="relation"))==null?void 0:n.args)!=null?t:[])}).map(i=>i.name);return r.map(i=>{if(i.type==="model"&&l.includes(i.name)){const s={...i};return{...s,properties:s.properties.filter(n=>{var t,c,u;if(n.type==="field"&&n.fieldType===a){const{name:f}=m.extractRelationAttributeArgs((u=(c=(t=n.attributes)==null?void 0:t.find(p=>p.name==="relation"))==null?void 0:c.args)!=null?u:[]);return!o.includes(f)}return!0})}}return i})},I=e=>({addModel:a=>{const r=[...e,a];return E(a,r)},updateModel:a=>{const r=e.find(s=>s.id===a.id);if(!r)return e;const l=r==null?void 0:r.properties.filter(s=>{var n;return s.type==="field"&&((n=s.attributes)==null?void 0:n.find(t=>t.name==="relation"))}).map(s=>s),o=a.properties.filter(s=>{var n;return s.type==="field"&&((n=s.attributes)==null?void 0:n.find(t=>t.name==="relation"))}).map(s=>s),i=l.filter(s=>!o.find(n=>{var t,c;return JSON.stringify((t=n.attributes)==null?void 0:t.find(u=>u.name==="relation"))===JSON.stringify((c=s.attributes)==null?void 0:c.find(u=>u.name==="relation"))}));return E(a,P(i,a.name,e).map(s=>s.id===a.id?a:s))},addEnum:a=>[...e,a],addEnums:a=>[...e,...a],updateEnum:a=>e.map(r=>r.id===a.id?a:r),deleteEntity:a=>{const r=e.find(o=>o.id===a);if(!r)return e;const l=r.name;return e.filter(o=>o.id!==a).map(o=>o.type==="model"?{...o,properties:o.properties.filter(i=>!(i.type==="field"&&i.fieldType===l))}:o)},cleanEmptyNameEntity:()=>e.filter(a=>!(["enum","model"].includes(a.type)&&!a.name)),updateEntityName:(a,r)=>{const l=e.find(o=>o.id===a).name;return e.map(o=>{if(o.id!==a&&o.type==="model"){const i={...o},s=[...i.properties];return{...i,properties:s.map(n=>n.type==="field"&&n.fieldType===l?{...n,fieldType:r}:n)}}return o.id===a&&["enum","model"].includes(o.type)?{...o,name:r}:o})}});S(()=>{k.error("\u5F53\u524Dschema\u4E0D\u5408\u6CD5",3)},3e3);const ne=()=>{const e=R(),{state:{blocks:a,currentDBSource:r,originBlocks:l},dispatch:o}=_.exports.useContext(v);return{blocks:a,originBlocks:l,updateAndSaveBlock:c=>(c.forEach(u=>{u.type==="model"&&!u.properties&&(u.properties=[])}),D(c,r.id).then(()=>B(String(r.id),o)).catch(u=>{throw o(F(I(a).cleanEmptyNameEntity())),k.error(e.formatMessage({id:"waeVf8",defaultMessage:[{type:0,value:"\u6570\u636E\u8FC1\u79FB\u5931\u8D25\uFF01error: "},{type:1,value:"error"}]},{error:u.message})),u})),applyLocalSchema:c=>{try{M(c,o)}catch{}},applyLocalBlocks:c=>{b(c,o)},refreshBlocks:()=>B(String(r.id),o)}},ae=()=>{const{state:{currentEntityId:e,blocks:a},dispatch:r}=_.exports.useContext(v),l=a.find(i=>i.id===e);return{currentEntityId:e,currentEntity:l,changeToEntityById:i=>{const s=a.find(c=>c.id===i),n=a.filter(c=>["enum","model"].includes(c.type)),t=n.length>0?n[0].id:0;r(C(s?i:t))}}},ie=()=>{const{state:{currentDBSource:e}}=_.exports.useContext(v);return e},re=()=>{const{state:{blocks:e,delMap:a,editMap:r,newMap:l}}=_.exports.useContext(v),o=()=>Math.max(...e.map(i=>i.id))+1;return{entities:e.filter(i=>["enum","model"].includes(i.type)).map(i=>i),delMap:a,editMap:r,newMap:l,getNextId:o,getFirstEntity:()=>e.find(i=>["enum","model"].includes(i.type))}},L="_pannel_1wiva_1",V="_title_1wiva_6",q="_select_1wiva_11",U="_actions_1wiva_14",W="_manage_1wiva_22",O="_refreshBtn_1wiva_60",J="_switchBtn_1wiva_72",K="_erBtn_1wiva_76",$="_addEntityBtn_1wiva_80",j="_item_1wiva_93",H="_icon_1wiva_104",z="_dropdownIcon_1wiva_112",G="_editMark_1wiva_126",Q="_addMark_1wiva_127",X="_itemActive_1wiva_130",Y="_name_1wiva_144",se={pannel:L,title:V,select:q,actions:U,manage:W,"option-icon":"_option-icon_1wiva_25","select-contain":"_select-contain_1wiva_31","delete-label":"_delete-label_1wiva_39","add-btn":"_add-btn_1wiva_42","dropdown-icon":"_dropdown-icon_1wiva_52",refreshBtn:O,switchBtn:J,erBtn:K,addEntityBtn:$,item:j,icon:H,dropdownIcon:z,editMark:G,addMark:Q,itemActive:X,name:Y};export{m as A,I as P,re as a,ie as b,ne as c,se as s,ae as u};
